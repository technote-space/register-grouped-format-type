language: node_js
node_js:
  - '11'

sudo: false
dist: trusty

git:
  depth: 3

cache: yarn

notifications:
  email: false
  slack:
    rooms:
      - secure: eDd6HKlv7rxP5NBOI+5g11ZJCWc9MqV0gK03+rvCRjTQuuOG6s46RfxzqbzEM+HSNOI+7aw71hf1/611GAO3Qday3Hqu38b2KfHyOCLsntRRbDRiAYUTjJClAwjNvHsSFcovWSPAmdF3t8utYm3ZFI6LQRIesDd0aN5eoLGb8n7RRP70SpaAMRFjpEXKPqt/WIck6+bhTBoTl27Hiiajc3GvKB7V+hCDHJg8J9ktTkbQY0d9Rcu00jRrDPfBLJD4gAemkcozZAsy27cimaBWELAWR3enWFH3Fvvtl6aRG+lhQWA0R0zsgdZ3XUglZHRBYAY+cTV0kcehdwubBrHPF5KChawG+WbyASHcmmegcMi6uIq0pNQixwcbCIxx6gPasxiLHdKlva3KDw7fI3V5K5fmONX9CH6rjkXXyANVftCHxLyYdNkB26vmynSUClYPQLUTpAmurv/a9gMhMHjMVyspQ/WmzYOQComRz0Qr7MX04IoAtF8QfaonZOexFq77faqqN8/tT8zrVOfLtx4pYXFx1OpTWxbkKmqQCOOwMjkVTpNFjYzOlQ3F8JEYZmrCqoTiZ+18e16Xhi8bNeX/d4m9GQt6gzba9SEldkR9uXzWeMZ50PY1uW8QnaQL50NnRq1AfMSFGKXHvBM5llaEvX+kLJB8Rx4GYN1NrRaETwI=

branches:
  only:
    - master
    - "/^v[0-9\\.]+/"

stages:
  - name: check
    if: branch = master and tag IS blank and type IN (pull_request, api)
  - name: test
    if: branch = master and tag IS blank and type IN (pull_request, api)
  - name: deploy
    if: tag IS present

before_script:
  - git clone --depth=1 https://github.com/wp-content-framework/travis-ci.git travis-ci

jobs:
  fast_finish: true
  include:
    - stage: check
      language: node_js
      node_js: '11'
      dist: trusty
      script: bash travis-ci/bin/js/js-lint.sh

    - stage: test
      language: node_js
      node_js: '10'
      dist: trusty
      script: bash travis-ci/bin/js/js-test.sh
    - stage: test
      language: node_js
      node_js: '11'
      dist: trusty
      env: COVERAGE_REPORT=1
      script: bash travis-ci/bin/js/js-test.sh

    - stage: deploy
      language: node_js
      node_js: '11'
      dist: trusty
      script: skip
      before_deploy: yarn build
      deploy:
        provider: releases
        skip_cleanup: true
        name: ${TRAVIS_TAG}
        tag_name: ${TRAVIS_TAG}
        draft: true
        api_key:
          secure: H4a+PbK+KtyubYSlPpqxDGX2a8Qbv6mYPVd8yGFhMguC4LFd5RyoC+2mT6ZQfALX8zlYJeI4YIR+IzrNF2FwfkwvXTMoif23klhcVnH7S8uu0DTUXQU3WkptqH7ju7UOccbQj0p4wlunxHYLUUem7U3RaBholCtgyUEpMzQGntMZ3NShTAq6cVQfpoHjRLGh0siyBS1I4lC6rceOhfmatw0flbWlXSaWVTgEhAD50oH2vMK/DAsz/BeG4MAFPRXphVbAcDCiZLsOGD8at5mDlwyBkJrBWNmElNjt4klXXwhun/WSsRj/i78KoPVBArj0YwG4sEUFpV2egPHXTFMlcQjt8xNtsQcjmGa+/+fUwZiFgyIDt7aC9qTSjpOPaqq4b389gzgL6ELace7BCZdH/alyTHizWDR7nipZ6Ux4KkFYrEaVlCvooBSDsDsDV9u0/ckwRlEHTB8ZCCUkJ7mpMJIHjdLd2949bJ2HG7zCS87vG8i06pQkTKy8m89DX4ILFDtNHWDyKBLq7C7eZuM5EiVUDInrsiMoxFyJ3AmBKAWn4LKsZ9aS3PLkRnWgCbvckWHOfZdvLd/yZx0CAYM6iAYQoPLA6NxXfe6+yxR998MoeTYX2fTdIZJmTrBHiaPcQLKGVLu1mpuWO5uNFIcC8h0GUAqz4bsA1+FUmlwOMmo=
        file: "build/index.js"
        overwrite: true
        on:
          tags: true

    - stage: deploy
      language: node_js
      node_js: '11'
      dist: trusty
      script: skip
      before_deploy: yarn build
      deploy:
        provider: npm
        skip_cleanup: true
        email: technote.space@gmail.com
        api_key:
          secure: RVo5t242bOb8K58LLueHrGFISaG6FxFTbDF8KmAJbVjVKbNeBuFKluaA5xfSGwXxP9YVilruMfaqk4IQYEE+z2PbgNX7UAgA1nI9hTOxBEi+ZX/ToB3Y9U8J51FuYRNVaQmG7qz7J1dG3YgHM6RBGCT5RT0wb6noNZYEE44bxH+1I7TmoyHHw19pPqcsmLhjmEBUjKq6Nn4FkMjc3cbk47WJtGhBUpgTnH9vqFOJ9/aXrPKkVhw1+Qpmlb69+XmA+s2zvjsbOooDoMWZZne4Vja3N5VFJiWPTGHpTuDj97tBcUU1Wd7YwVzGdjF6FZAzdhkZJLhct+5QwEKZmEnDze7hVRPMFyYIYO1qyasP+2YpXFlr3SBMF73mzON6VIwOn+kqmS01B0gNSql+H/P49Apv5S9ogB8gbl1VO9zoGFbmkYgI8yYryW1/1D0uXI+fV1M0rTphUxycKhhkKtn/yT1k6WEDjy2nLR60oEvtkn+RKLAYdAMftQGgXEL+GisrWjhnfNk/mSNclqa6cOZA0aBvHgOXd0gN4qcJDjMQEupIOlAe2xKc35MgjNiTHOIkuKjocTLsEhdFxfsKXQEta6vofSgHZIPoAu283CVhq09LdYutzdoIBA/9PuZ6qVdpQ14gtZ9SQkmznTF+kDAs8knvlW2OFG7a7b4KhKetZ3M=
        on:
          tags: true
